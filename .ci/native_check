#!/bin/bash

# Retrieve the names of all directories at the project's root
ROOT_DIRS=$(find . -maxdepth 1 -type d | cut -c 3- | egrep -v '^\.(git|github|ci)$')

# Variable to store namespace errors
NS_ERRORS=""

# Function to check if a file should be excluded
is_excluded() {
    local file=$1
    [[ "$file" == ".github"* || "$file" == ".ci"* || "$file" == ".git"* || "$file" == "README.md" ]]
}

# Iterate over all files included in the last commit
git diff --name-only HEAD^ | while read file; do
    # Skip excluded files or directories
    if is_excluded "$file"; then
        continue
    fi

    # Attempt to extract the namespace from the file, assuming it's specified as "--- ns: XXXX"
    NS=$(sed -n '/^---$/,/^---$/{/^ns:/p;}' "$file" | sed 's/ns: //')

    # If no namespace is extracted, continue to the next file
    if [ -z "$NS" ]; then
        continue
    fi

    # Check if the extracted namespace exists among the root directories
    if ! grep -q "^$NS$" <<< "$ROOT_DIRS"; then
        # If the namespace doesn't exist, add an error message
        NS_ERRORS+="\nError: Namespace '$NS' in file '$file' does not exist."
    fi
done

# Output namespace errors if any
if [ ! -z "$NS_ERRORS" ]; then
    echo -e "$NS_ERRORS"
    exit 1
else
    echo "All namespaces are valid."
fi
