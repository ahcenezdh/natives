#!/bin/bash

# Set bash to exit immediately if any command fails and treat unset variables as an error
set -eu

# Include the common utility script
. "$(dirname "$0")"/common.sh

# Use a flag to indicate failure
failure_detected=0

# Function to list changed Markdown files in a commit range
changed_files() {
    local commit_range="$1"
    # List only Markdown files that were Added (A), Copied (C), Modified (M), or Renamed (R)
    git diff --name-only --diff-filter=ACMR "$commit_range" -- '*.md'
}

# Determine the commit range for the current push
COMMIT_RANGE="${COMMIT_LIST:-$(git rev-parse HEAD~1)..HEAD}"

title "Verifying namespaces in changed Markdown files between $COMMIT_RANGE"

echo 'Affected Markdown files:'
changed_files "$COMMIT_RANGE" | while read file; do
    if [ -z "$file" ]; then continue; fi  # Skip if no file is found

    # Skip specific directories and the README.md file
    if [[ "$file" == .ci/* || "$file" == .github/* || "$file" == .git/* || "$file" == "README.md" ]]; then
        continue
    fi

    fold_start "$file" "Verifying $file"

    # Attempt to extract the namespace from the file
    NS=$(sed -n '/^---$/,/^---$/{/^ns:/p;}' "$file" | sed 's/ns: //' | tr -d '[:space:]')

    if [ -z "$NS" ]; then
        fold_end "$file"
        continue
    fi

    # Check if the namespace directory exists at the project root
    if [ ! -d "$NS" ]; then
        print -s0 -c1 "Invalid namespace '$NS' in $file."
        failure_detected=1
    fi

    fold_end "$file"
done

# Final output and exit handling
printf '\n----\n'

if [ "$failure_detected" -eq 1 ]; then
    die "Some namespaces are invalid. Check above for details."
else
    print -s1 -c2 'All namespaces are valid or no Markdown files were changed.'
fi
